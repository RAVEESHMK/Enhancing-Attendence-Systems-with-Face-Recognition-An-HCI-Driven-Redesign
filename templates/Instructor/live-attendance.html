<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Attendance - {{ course.name }}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6366F1;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .video-container {
            background: #1F2937;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
        }
        
        #videoFeed {
            width: 100%;
            height: 400px;
            object-fit: cover;
        }
        
        .recognition-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        
        .face-box {
            position: absolute;
            border: 3px solid var(--success);
            background: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
        }
        
        .face-label {
            position: absolute;
            background: var(--success);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/instructor/dashboard">
                <i class="fas fa-camera"></i> FaceAttend
            </a>
            <div class="navbar-text">
                <span class="me-3 text-white">Live: {{ course.name }}</span>
                <a href="/instructor/dashboard" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="text-white">{{ course.name }} - Live Attendance</h2>
                        <p class="text-white-50 mb-0">Date: {{ today }}</p>
                    </div>
                    <div class="text-end">
                        <div class="btn-group">
                            <button id="startCamera" class="btn btn-success">
                                <i class="fas fa-camera"></i> Start Camera
                            </button>
                            <button id="stopCamera" class="btn btn-danger" disabled>
                                <i class="fas fa-stop"></i> Stop Camera
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Video Feed -->
            <div class="col-lg-8 mb-4">
                <div class="video-container">
                    <video id="videoFeed" autoplay muted playsinline></video>
                    <canvas id="canvas" style="display: none;"></canvas>
                    <div class="recognition-overlay" id="recognitionOverlay"></div>
                    
                    <div class="position-absolute top-0 end-0 m-3">
                        <div class="bg-dark bg-opacity-75 text-white p-3 rounded">
                            <div class="small">Status: <span id="status">Ready</span></div>
                            <div class="small">Recognized: <span id="recognizedCount">0</span> students</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        Position students clearly in front of the camera. The system will automatically recognize and mark attendance.
                    </div>
                </div>
            </div>

            <!-- Controls & Results -->
            <div class="col-lg-4">
                <!-- Attendance Summary -->
                <div class="glass-card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar"></i> Attendance Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="h3 text-success" id="presentCount">{{ present_students|length }}</div>
                                <small class="text-muted">Present</small>
                            </div>
                            <div class="col-6">
                                <div class="h3 text-muted" id="totalCount">{{ students|length }}</div>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                        <div class="progress mt-3" style="height: 10px;">
                            <div id="attendanceProgress" class="progress-bar bg-success" 
                                 style="width: {{ (present_students|length / students|length * 100) if students|length > 0 else 0 }}%">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manual Override -->
                <div class="glass-card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-user-edit"></i> Manual Override
                        </h5>
                    </div>
                    <div class="card-body">
                        <select id="studentSelect" class="form-select mb-3">
                            <option value="">Select Student</option>
                            {% for student in students %}
                            <option value="{{ student.id }}" 
                                    {% if student.id in present_students %}disabled{% endif %}>
                                {{ student.name }} {% if student.id in present_students %}(Already marked){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <button id="manualMark" class="btn btn-warning w-100" disabled>
                            <i class="fas fa-check"></i> Mark as Present
                        </button>
                    </div>
                </div>

                <!-- Recent Recognitions -->
                <div class="glass-card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-clock"></i> Recent Recognitions
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="recognitionList" class="list-group list-group-flush" 
                             style="max-height: 300px; overflow-y: auto;">
                            {% for student in students if student.id in present_students %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ student.name }}</strong>
                                        <div class="text-muted small">Manually added</div>
                                    </div>
                                    <span class="badge bg-success">Present</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const courseId = {{ course.id }};
        let stream = null;
        let recognitionInterval = null;
        const recognizedStudents = new Set({{ present_students | tojson }});

        // DOM Elements
        const video = document.getElementById('videoFeed');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startCamera');
        const stopBtn = document.getElementById('stopCamera');
        const statusEl = document.getElementById('status');
        const recognizedCountEl = document.getElementById('recognizedCount');
        const presentCountEl = document.getElementById('presentCount');
        const totalCountEl = document.getElementById('totalCount');
        const attendanceProgress = document.getElementById('attendanceProgress');
        const studentSelect = document.getElementById('studentSelect');
        const manualMarkBtn = document.getElementById('manualMark');
        const recognitionList = document.getElementById('recognitionList');

        // Start Camera
        startBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' } 
                });
                video.srcObject = stream;
                
                startBtn.disabled = true;
                stopBtn.disabled = false;
                statusEl.textContent = 'Camera Active';
                
                // Start recognition every 3 seconds
                recognitionInterval = setInterval(captureAndRecognize, 3000);
                
            } catch (err) {
                console.error('Error accessing camera:', err);
                alert('Error accessing camera. Please ensure you have granted camera permissions.');
            }
        });

        // Stop Camera
        stopBtn.addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            if (recognitionInterval) {
                clearInterval(recognitionInterval);
                recognitionInterval = null;
            }
            
            startBtn.disabled = false;
            stopBtn.disabled = true;
            statusEl.textContent = 'Camera Stopped';
        });

        // Capture frame and send for recognition
        function captureAndRecognize() {
            if (video.videoWidth === 0) return;
            
            // Set canvas size to video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw current video frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to base64
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Send to recognition API
            fetch('/api/recognize-face', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image: imageData,
                    course_id: courseId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.recognized_faces) {
                    processRecognitions(data.recognized_faces);
                }
            })
            .catch(error => {
                console.error('Recognition error:', error);
            });
        }

        // Process recognition results
        function processRecognitions(faces) {
            faces.forEach(face => {
                if (!recognizedStudents.has(face.user_id)) {
                    recognizedStudents.add(face.user_id);
                    updateAttendanceDisplay();
                    addRecognitionToList(face);
                }
            });
        }

        // Update attendance counters
        function updateAttendanceDisplay() {
            const presentCount = recognizedStudents.size;
            const totalCount = {{ students|length }};
            const percentage = (presentCount / totalCount * 100).toFixed(1);
            
            presentCountEl.textContent = presentCount;
            recognizedCountEl.textContent = presentCount;
            attendanceProgress.style.width = `${percentage}%`;
        }

        // Add recognition to recent list
        function addRecognitionToList(face) {
            const item = document.createElement('div');
            item.className = 'list-group-item';
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${face.name}</strong>
                        <div class="text-muted small">
                            ${face.timestamp} â€¢ ${face.confidence}% confidence
                        </div>
                    </div>
                    <span class="badge bg-success">Recognized</span>
                </div>
            `;
            recognitionList.insertBefore(item, recognitionList.firstChild);
            
            // Limit to 10 items
            if (recognitionList.children.length > 10) {
                recognitionList.removeChild(recognitionList.lastChild);
            }
        }

        // Manual attendance
        studentSelect.addEventListener('change', () => {
            manualMarkBtn.disabled = !studentSelect.value;
        });

        manualMarkBtn.addEventListener('click', () => {
            const studentId = studentSelect.value;
            if (!studentId) return;
            
            fetch('/api/manual-attendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    student_id: studentId,
                    course_id: courseId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    recognizedStudents.add(parseInt(studentId));
                    updateAttendanceDisplay();
                    
                    // Add to recognition list
                    addRecognitionToList({
                        name: data.student_name,
                        timestamp: data.timestamp,
                        confidence: 100
                    });
                    
                    // Disable the selected option
                    studentSelect.querySelector(`option[value="${studentId}"]`).disabled = true;
                    studentSelect.value = '';
                    manualMarkBtn.disabled = true;
                }
            });
        });

        // Initialize
        updateAttendanceDisplay();
    </script>
</body>
</html>